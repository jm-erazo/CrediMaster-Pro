<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrediMaster Pro by Jose Mejia</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300&display=swap" rel="stylesheet">
    
    <!-- Babel para procesar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Merriweather', serif; }
        .animate-in { animation: animateIn 0.5s ease-out; }
        .fade-in { opacity: 0; animation-fill-mode: forwards; animation-name: fadeIn; }
        .slide-in-from-bottom-4 { transform: translateY(1rem); animation-fill-mode: forwards; animation-name: slideIn; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(1rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        html, body { overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .letter-paper { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: none !important; }
        }
    </style>

    <!-- Import Map: Define dónde buscar las librerías 'react', 'recharts', etc. -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0"
        }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Tu código React original, usando data-type="module" para soportar imports -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        
        import { 
            PieChart, DollarSign, Calendar, AlertTriangle, ArrowRight, 
            Menu, X, BrainCircuit, Wallet, Target, BarChart3, ShieldCheck, 
            List, ChevronRight, Info, Printer, Sparkles, Bot, Settings, 
            FileText, TrendingDown, TrendingUp, Share2, Copy, Calculator, PiggyBank,
            Coffee, Home, Car, ShoppingBag, Zap, ExternalLink, User, Building2, CreditCard,
            RotateCcw, CheckCircle2, Code2, Coins, TrendingUp as TrendingUpIcon
        } from 'lucide-react';
        
        import { 
            XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, AreaChart, Area, Cell, Pie, PieChart as RechartsPieChart, LineChart, Line, Legend
        } from 'recharts';

        // --- CONFIGURACIÓN ---
        const apiKey = ""; 

        // --- UTILIDADES ---
        const formatCurrency = (value, decimals = 2) => {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            }).format(value || 0);
        };

        const formatNumber = (value, decimals = 2) => {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals,
            }).format(value || 0);
        };

        // Hook debounce para optimizar rendimiento
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                setDebouncedValue(value);
                }, delay);
                return () => {
                clearTimeout(handler);
                };
            }, [value, delay]);
            return debouncedValue;
        }

        // --- COMPONENTES UI GENÉRICOS ---

        // Input numérico mejorado para soportar decimales reales
        const NumericInput = ({ 
            label, 
            value, 
            onChange, 
            type = 'currency', // 'currency' | 'percent' | 'number' | 'uvr'
            className = '', 
            icon: Icon, 
            placeholder = "0", 
            highlight = false,
            decimals = 2 
        }) => {
            // Estado local para lo que escribe el usuario antes de blur
            const [inputValue, setInputValue] = useState('');

            // Sincronizar cuando el prop 'value' cambia externamente
            useEffect(() => {
                if (value === '' || value === null || value === undefined) {
                    setInputValue('');
                } else {
                    // Formatear visualmente al cargar
                    const opts = { minimumFractionDigits: 0, maximumFractionDigits: decimals };
                    setInputValue(new Intl.NumberFormat('es-CO', opts).format(value));
                }
            }, [value, decimals]);

            const handleFocus = () => {
                // Al enfocar, mostrar el valor sin formato (o formato simple) para editar fácil
                if (value !== 0 && value) {
                    setInputValue(value.toString().replace('.', ','));
                } else {
                    setInputValue('');
                }
            };

            const handleBlur = () => {
                // Al salir, el useEffect se encargará de formatear de nuevo el prop value
                // Forzamos el reformateo inmediato visual
                if (value !== '' && value !== null) {
                    const opts = { minimumFractionDigits: 0, maximumFractionDigits: decimals };
                    setInputValue(new Intl.NumberFormat('es-CO', opts).format(value));
                }
            };

            const handleChange = (e) => {
                let raw = e.target.value;
                // Permitir solo números y una coma
                // 1. Reemplazar puntos por nada (si usuario usa puntos como miles, los ignoramos al escribir manual)
                //    O si usa punto como decimal, lo volvemos coma.
                //    Estandaricemos: usuario escribe 1234,56
                
                // Filtro básico: permitir dígitos y comas
                if (/^[0-9.,]*$/.test(raw)) {
                     setInputValue(raw);
                     
                     // Convertir a número para el padre
                     // Eliminar puntos de miles (si los hubiera pegado) y cambiar coma por punto decimal JS
                     let numStr = raw.replace(/\./g, '').replace(',', '.');
                     
                     // Caso borde: usuario escribe solo "," o vacio
                     if (numStr === '' || numStr === '.') {
                         onChange(0);
                         return;
                     }

                     const parsed = parseFloat(numStr);
                     if (!isNaN(parsed)) {
                         onChange(parsed);
                     }
                }
            };

            return (
                <div className={`space-y-2 ${className}`}>
                    <label className={`text-xs font-bold uppercase tracking-wide flex flex-wrap justify-between gap-1 items-center ${highlight ? 'text-indigo-600' : 'text-slate-500'}`}>
                        <span className="flex items-center gap-1.5">
                            {Icon && <Icon size={14} className={highlight ? 'text-indigo-500' : 'text-slate-400'} />}
                            {label}
                        </span>
                        {type === 'percent' && <span className="text-slate-400 font-normal whitespace-nowrap">% E.A.</span>}
                        {type === 'uvr' && <span className="text-slate-400 font-normal whitespace-nowrap">Unidad</span>}
                    </label>
                    <div className="relative group">
                        {type === 'currency' && (
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span className={`font-semibold transition-colors ${highlight ? 'text-indigo-500' : 'text-slate-400 group-focus-within:text-blue-500'}`}>$</span>
                            </div>
                        )}
                        <input
                            type="text"
                            inputMode="decimal"
                            value={inputValue}
                            onChange={handleChange}
                            onFocus={handleFocus}
                            onBlur={handleBlur}
                            className={`block w-full rounded-xl p-3 text-sm font-bold focus:ring-2 shadow-sm transition-all outline-none border ${type === 'currency' ? 'pl-7' : ''} ${highlight ? 'bg-indigo-50 border-indigo-200 text-indigo-900 focus:border-indigo-500 focus:ring-indigo-200' : 'bg-slate-50 border-slate-200 text-slate-800 focus:border-blue-500 focus:ring-blue-200 focus:bg-white'}`}
                            placeholder={placeholder}
                        />
                        {type === 'percent' && (
                            <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span className="text-slate-400 font-semibold">%</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ToggleSwitch = ({ label, checked, onChange, activeColor = 'bg-emerald-500' }) => (
            <div className="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:bg-slate-50 transition-colors" onClick={() => onChange(!checked)}>
                <div className="text-sm font-medium text-slate-700 leading-tight select-none pr-2">
                    {label}
                </div>
                <div 
                    className={`relative inline-flex h-6 w-11 shrink-0 items-center rounded-full transition-colors focus:outline-none ${checked ? activeColor : 'bg-slate-300'}`}
                >
                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${checked ? 'translate-x-6' : 'translate-x-1'}`} />
                </div>
            </div>
        );

        // Componente reutilizable de Inputs
        const CreditParametersForm = ({ inputs, handleInputChange, className = "" }) => (
            <div className={`space-y-6 ${className}`}>
                <div className="space-y-4">
                    <div className="flex items-center gap-2 mb-2">
                        <div className="p-1.5 bg-blue-100 text-blue-600 rounded-lg">
                            <Settings size={16} />
                        </div>
                        <h3 className="text-sm font-bold text-slate-700 uppercase tracking-wide">Datos del Crédito</h3>
                    </div>

                    {/* Selector Tipo de Crédito */}
                    <div className="bg-slate-100 p-1 rounded-xl flex mb-4">
                        <button 
                            onClick={() => handleInputChange('isUVR', false)}
                            className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${!inputs.isUVR ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            PESOS (Tasa Fija)
                        </button>
                        <button 
                            onClick={() => handleInputChange('isUVR', true)}
                            className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${inputs.isUVR ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            UVR (Indexado inflación)
                        </button>
                    </div>

                    {inputs.isUVR && (
                        <div className="bg-purple-50 border border-purple-100 p-4 rounded-xl space-y-3 animate-in fade-in">
                            <div className="flex items-center gap-2 text-purple-800 font-bold text-xs uppercase mb-1">
                                <TrendingUpIcon size={14} /> Variables UVR
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <NumericInput 
                                    label="Valor Unidad UVR Hoy" 
                                    type="uvr"
                                    value={inputs.uvrValue} 
                                    onChange={(v) => handleInputChange('uvrValue', v)}
                                    decimals={4} 
                                />
                                <NumericInput 
                                    label="Inflación Estimada (Anual)" 
                                    type="percent"
                                    value={inputs.inflation} 
                                    onChange={(v) => handleInputChange('inflation', v)}
                                    decimals={2}
                                />
                            </div>
                            <p className="text-[10px] text-purple-600/80 leading-tight">
                                * El crédito en UVR aumenta su saldo en pesos con la inflación. Simulamos proyectando el crecimiento de la UVR.
                            </p>
                        </div>
                    )}
                    
                    <NumericInput 
                        label="Saldo Deuda Actual (Pesos)" 
                        value={inputs.loanAmount} 
                        onChange={(v) => handleInputChange('loanAmount', v)} 
                    />
                    
                    {/* CUOTA REAL / MANUAL */}
                    <div className="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 relative">
                        <div className="absolute -top-2 right-2 bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-bold">
                            Recomendado
                        </div>
                        <NumericInput 
                            label="Valor Cuota Extracto Total (Pesos)" 
                            value={inputs.currentQuota} 
                            onChange={(v) => handleInputChange('currentQuota', v)} 
                            highlight={true}
                            icon={CheckCircle2}
                            placeholder="Ej: 2.500.000"
                        />
                        <p className="text-[10px] text-indigo-500/80 mt-1.5 leading-tight px-1">
                            Ingresa el valor exacto de tu factura para calibrar el simulador.
                        </p>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <NumericInput 
                            label={inputs.isUVR ? "Tasa UVR + %" : "Tasa E.A."} 
                            type="percent"
                            value={inputs.rateEA} 
                            onChange={(v) => handleInputChange('rateEA', v)} 
                        />
                        <NumericInput 
                            label="Plazo Restante (Meses)" 
                            type="number" 
                            value={inputs.months} 
                            onChange={(v) => handleInputChange('months', v)}
                            decimals={0} 
                        />
                    </div>
                    <NumericInput 
                        label="Seguros / Otros (Mensual Pesos)" 
                        value={inputs.insurance} 
                        onChange={(v) => handleInputChange('insurance', v)} 
                    />
                </div>

                <div className="bg-emerald-50/80 p-5 rounded-2xl border border-emerald-100 space-y-4 shadow-sm">
                    <div className="flex items-center gap-2 mb-1">
                        <div className="p-1.5 bg-emerald-100 text-emerald-600 rounded-lg">
                            <Wallet size={16} />
                        </div>
                        <h3 className="text-sm font-bold text-emerald-800 uppercase tracking-wide">Tu Estrategia</h3>
                    </div>
                    <NumericInput 
                        label="Abono Extra Mensual (Pesos)" 
                        value={inputs.extraMonthly} 
                        onChange={(v) => handleInputChange('extraMonthly', v)} 
                        className="[&_input]:bg-white [&_input]:border-emerald-200 [&_input]:text-emerald-800 [&_input]:focus:ring-emerald-200 [&_input]:focus:border-emerald-500"
                    />
                    <ToggleSwitch 
                        label={<span className="text-xs font-semibold text-slate-600 block">Usar Primas (Jun/Dic) <span className="text-[10px] text-slate-400 font-normal block mt-0.5">Duplica el abono extra</span></span>}
                        checked={inputs.usePrimas}
                        onChange={(v) => handleInputChange('usePrimas', v)}
                    />
                    <NumericInput 
                        label="Abono Único Inicial (Pesos)" 
                        value={inputs.oneTimePayment} 
                        onChange={(v) => handleInputChange('oneTimePayment', v)} 
                    />
                </div>
            </div>
        );

        // --- LÓGICA DE NEGOCIO ---

        const calculateEngine = (params) => {
            const { 
                loanAmount, rateEA, months, insurance, extraMonthly, 
                usePrimas, oneTimePayment, currentQuota, 
                isUVR, uvrValue, inflation 
            } = params;
            
            if (!loanAmount || !rateEA || (isUVR && !uvrValue)) return null;

            // Tasas Efectivas a Nominales Mensuales
            const rateMonthly = Math.pow(1 + rateEA / 100, 1 / 12) - 1;
            const inflationMonthly = isUVR ? (Math.pow(1 + inflation / 100, 1 / 12) - 1) : 0;

            // --- INICIALIZACIÓN ---
            
            // Si es UVR, convertimos el saldo inicial a UVR
            let balanceBaseUVR = isUVR ? (loanAmount / uvrValue) : loanAmount;
            let balanceBasePesos = loanAmount;
            
            let balanceStrategyUVR = balanceBaseUVR;
            let balanceStrategyPesos = loanAmount;

            let currentUVR = isUVR ? uvrValue : 1; // Factor de conversión

            // Cálculo de Cuota Base (Obligatoria)
            // Para UVR, calculamos la cuota fija EN UVR.
            // Para Pesos, calculamos la cuota fija EN PESOS.
            
            let pmtFixedUnit; // Será UVR o Pesos según el modo
            let pmtTotalObligatoryDisplay; // Para mostrar en el dashboard (Primer mes)
            let isManualQuota = false;

            if (currentQuota && currentQuota > insurance) {
                // Modo Calibrado: Usuario da la cuota en PESOS
                isManualQuota = true;
                const quotaWithoutInsurance = currentQuota - insurance;
                
                if (isUVR) {
                    // Convertimos esa cuota inicial a UVR para proyectar
                    pmtFixedUnit = quotaWithoutInsurance / uvrValue;
                } else {
                    pmtFixedUnit = quotaWithoutInsurance;
                }
                pmtTotalObligatoryDisplay = currentQuota;
            } else {
                // Modo Automático: Fórmula Francesa
                if (!months) return null;
                // Fórmula: P * (r * (1+r)^n) / ((1+r)^n - 1)
                pmtFixedUnit = balanceBaseUVR * (rateMonthly * Math.pow(1 + rateMonthly, months)) / (Math.pow(1 + rateMonthly, months) - 1);
                
                const firstMonthPaymentPesos = isUVR 
                    ? (pmtFixedUnit * (uvrValue * (1 + inflationMonthly))) + insurance 
                    : pmtFixedUnit + insurance;
                    
                pmtTotalObligatoryDisplay = firstMonthPaymentPesos;
            }


            // --- SIMULACIÓN BANCO (SIN ABONOS) ---
            let totalInterestBasePesos = 0;
            const scheduleBase = [];
            let monthCounter = 0;
            const SAFE_LIMIT = 600; 

            // Clonamos variables para el loop
            let tempBalanceUnit = balanceBaseUVR; // Unit es UVR o Pesos
            let tempUVR = currentUVR;

            while (tempBalanceUnit > (isUVR ? 0.1 : 100) && monthCounter < SAFE_LIMIT) {
                monthCounter++;
                
                // Actualizar valor UVR si aplica
                if (isUVR) tempUVR = tempUVR * (1 + inflationMonthly);

                // Interés del mes (Sobre saldo en Unidades)
                const interestUnit = tempBalanceUnit * rateMonthly;
                
                // Capital (Cuota Fija Unitaria - Interés)
                let capitalUnit = pmtFixedUnit - interestUnit;
                
                // Ajuste último mes
                if (capitalUnit > tempBalanceUnit) capitalUnit = tempBalanceUnit;
                if (capitalUnit < 0) capitalUnit = 0; // Amortización negativa (UVR mal configurado o tasas extremas)

                tempBalanceUnit -= capitalUnit;

                // Acumuladores en Pesos (Para comparar peras con peras)
                const interestPesos = isUVR ? interestUnit * tempUVR : interestUnit;
                totalInterestBasePesos += interestPesos;

                scheduleBase.push({
                    month: monthCounter,
                    balancePesos: isUVR ? tempBalanceUnit * tempUVR : tempBalanceUnit,
                    uvrValue: tempUVR
                });
            }
            
            const totalMonthsOriginal = scheduleBase.length;
            // Estimado total pago original en pesos (aprox)
            // Nota: En UVR esto es complejo porque los seguros también pueden subir o ser fijos. Asumimos fijos en pesos por simpleza UI.


            // --- SIMULACIÓN ESTRATEGIA (CON ABONOS) ---
            let schedule = [];
            let totalInterestStrategyPesos = 0;
            let totalInsurancePesos = 0;
            let currentMonth = 0;
            
            // Reiniciamos variables
            tempBalanceUnit = balanceStrategyUVR;
            tempUVR = isUVR ? uvrValue : 1;

            const graphData = [];
            graphData.push({
                mes: 0,
                deudaBanco: Math.round(loanAmount),
                deudaEstrategia: Math.round(loanAmount),
            });

            while (tempBalanceUnit > (isUVR ? 0.1 : 100) && currentMonth < SAFE_LIMIT) {
                currentMonth++;
                
                // 1. Proyección UVR
                if (isUVR) tempUVR = tempUVR * (1 + inflationMonthly);
                
                // 2. Cálculo Interés
                const interestUnit = tempBalanceUnit * rateMonthly;
                
                // 3. Cálculo Capital Ordinario
                let capitalOrdinaryUnit = pmtFixedUnit - interestUnit;
                if (capitalOrdinaryUnit < 0) capitalOrdinaryUnit = 0;

                // 4. Definir Abonos Extras (Input es en PESOS)
                let paymentExtraPesos = extraMonthly;
                if (usePrimas && (currentMonth % 12 === 6 || currentMonth % 12 === 0)) paymentExtraPesos += extraMonthly; 
                if (currentMonth === 1) paymentExtraPesos += oneTimePayment;

                // Convertir Extra Pesos a Unidades (UVR o Pesos)
                let paymentExtraUnit = isUVR ? (paymentExtraPesos / tempUVR) : paymentExtraPesos;

                // 5. Capital Total
                let capitalTotalUnit = capitalOrdinaryUnit + paymentExtraUnit;

                // Ajuste final saldo
                if (capitalTotalUnit > tempBalanceUnit) {
                    capitalTotalUnit = tempBalanceUnit;
                    // Ajuste proporcional para visualización
                    if (tempBalanceUnit < capitalOrdinaryUnit) {
                         capitalOrdinaryUnit = tempBalanceUnit;
                         paymentExtraUnit = 0;
                    } else {
                         paymentExtraUnit = tempBalanceUnit - capitalOrdinaryUnit;
                    }
                }

                tempBalanceUnit -= capitalTotalUnit;
                
                // Conversiones a Pesos para reporte
                const interestPesos = isUVR ? interestUnit * tempUVR : interestUnit;
                const capitalOrdinaryPesos = isUVR ? capitalOrdinaryUnit * tempUVR : capitalOrdinaryUnit;
                const capitalTotalPesos = isUVR ? capitalTotalUnit * tempUVR : capitalTotalUnit;
                const paymentExtraAppliedPesos = isUVR ? paymentExtraUnit * tempUVR : paymentExtraUnit;
                const balancePesos = isUVR ? tempBalanceUnit * tempUVR : tempBalanceUnit;
                
                // Pago Total Bolsillo
                const totalPaymentPocketPesos = capitalTotalPesos + interestPesos + insurance;

                totalInterestStrategyPesos += interestPesos;
                totalInsurancePesos += insurance;

                schedule.push({
                    month: currentMonth,
                    paymentTotal: totalPaymentPocketPesos,
                    capitalOrdinary: capitalOrdinaryPesos,
                    capitalTotal: capitalTotalPesos,
                    interest: interestPesos,
                    insurance: insurance,
                    balance: balancePesos > 1 ? balancePesos : 0,
                    extraApplied: paymentExtraAppliedPesos,
                    uvrUnitValue: isUVR ? tempUVR : null // Dato extra para la tabla
                });

                // Gráfica
                const baseData = scheduleBase[currentMonth - 1] || { balancePesos: 0 };
                if (currentMonth % 3 === 0 || tempBalanceUnit <= (isUVR?0.1:100) || currentMonth === 1) {
                    graphData.push({
                        mes: currentMonth,
                        deudaBanco: Math.round(baseData.balancePesos),
                        deudaEstrategia: Math.round(balancePesos > 0 ? balancePesos : 0),
                    });
                }
            }

            // Rellenar gráfica
            if (currentMonth < totalMonthsOriginal) {
                graphData.push({
                    mes: totalMonthsOriginal,
                    deudaBanco: 0,
                    deudaEstrategia: 0
                });
            }

            // Métricas Finales
            // Aproximación del pago total original (Banco) sumando intereses proyectados + capital inicial + seguros
            const totalPaymentOriginalPesos = loanAmount + totalInterestBasePesos + (insurance * totalMonthsOriginal);
            const totalPaymentNewPesos = loanAmount + totalInterestStrategyPesos + totalInsurancePesos;

            return {
                metrics: {
                    originalTerm: totalMonthsOriginal,
                    newTerm: schedule.length,
                    monthsSaved: totalMonthsOriginal - schedule.length,
                    interestSaved: totalInterestBasePesos - totalInterestStrategyPesos,
                    totalPaymentOriginal: totalPaymentOriginalPesos,
                    totalPaymentNew: totalPaymentNewPesos,
                    monthlyObligatory: pmtTotalObligatoryDisplay, // Muestra 1er mes aprox
                    monthlyTotalEffort: pmtTotalObligatoryDisplay + extraMonthly, 
                    effortIncreasePct: (extraMonthly / pmtTotalObligatoryDisplay) * 100,
                    timeReductionPct: ((totalMonthsOriginal - schedule.length) / totalMonthsOriginal) * 100,
                    isManualQuota,
                    isUVR
                },
                graphData,
                schedule
            };
        };

        // --- VISTAS ---

        const BudgetView = ({ onApplyExtra }) => {
            const [finances, setFinances] = useState({
                income: 5000000,
                housing: 1200000,
                food: 800000,
                transport: 400000,
                utilities: 300000,
                entertainment: 300000,
                others: 200000
            });

            const totalExpenses = Object.values(finances).reduce((a,b) => a+b, 0) - finances.income; // Fix logic below
            const totalExpensesReal = finances.housing + finances.food + finances.transport + finances.utilities + finances.entertainment + finances.others;
            const surplus = finances.income - totalExpensesReal;
            const recommendedExtra = Math.max(0, surplus * 0.7); 

            const handleChange = (field, value) => {
                setFinances(prev => ({ ...prev, [field]: value }));
            };

            const dataPie = [
                { name: 'Vivienda', value: finances.housing, color: '#3b82f6' },
                { name: 'Alimentación', value: finances.food, color: '#10b981' },
                { name: 'Transporte', value: finances.transport, color: '#f59e0b' },
                { name: 'Servicios', value: finances.utilities, color: '#6366f1' },
                { name: 'Ocio', value: finances.entertainment, color: '#ec4899' },
                { name: 'Otros', value: finances.others, color: '#94a3b8' },
            ].filter(item => item.value > 0);

            return (
                <div className="space-y-6 pb-24 lg:pb-0 animate-in fade-in slide-in-from-bottom-4">
                    <div className="bg-gradient-to-r from-blue-900 to-slate-900 p-6 rounded-2xl text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10">
                            <h2 className="text-2xl font-bold mb-2">Estudio Financiero</h2>
                            <p className="text-blue-200 text-sm max-w-xl">
                                Analiza tus ingresos y gastos para descubrir cuánto puedes realmente abonar a tu deuda.
                            </p>
                        </div>
                        <div className="absolute right-0 top-0 opacity-10 p-4">
                            <Calculator size={100} />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                            <div>
                                <h3 className="text-sm font-bold text-slate-700 uppercase tracking-wide mb-4 flex items-center">
                                    <Wallet size={16} className="mr-2 text-emerald-600"/> Ingresos Mensuales
                                </h3>
                                <NumericInput 
                                    label="Total Ingresos (Neto)" 
                                    value={finances.income} 
                                    onChange={(v) => handleChange('income', v)} 
                                />
                            </div>

                            <div className="space-y-4">
                                <h3 className="text-sm font-bold text-slate-700 uppercase tracking-wide mb-2 flex items-center">
                                    <ShoppingBag size={16} className="mr-2 text-rose-500"/> Gastos Mensuales
                                </h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <NumericInput label="Vivienda" icon={Home} value={finances.housing} onChange={(v) => handleChange('housing', v)} />
                                    <NumericInput label="Alimentación" icon={Coffee} value={finances.food} onChange={(v) => handleChange('food', v)} />
                                    <NumericInput label="Transporte" icon={Car} value={finances.transport} onChange={(v) => handleChange('transport', v)} />
                                    <NumericInput label="Servicios" icon={Zap} value={finances.utilities} onChange={(v) => handleChange('utilities', v)} />
                                    <NumericInput label="Ocio / Varios" icon={Sparkles} value={finances.entertainment} onChange={(v) => handleChange('entertainment', v)} />
                                    <NumericInput label="Deudas / Otros" icon={CreditCardIcon} value={finances.others} onChange={(v) => handleChange('others', v)} />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-6">Diagnóstico de Flujo de Caja</h3>
                                <div className="flex flex-col sm:flex-row items-center gap-8">
                                    <div className="w-40 h-40 relative">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <RechartsPieChart>
                                                <Pie data={dataPie} cx="50%" cy="50%" innerRadius={40} outerRadius={60} paddingAngle={5} dataKey="value">
                                                    {dataPie.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                                </Pie>
                                                <Tooltip formatter={(value) => formatCurrency(value)} />
                                            </RechartsPieChart>
                                        </ResponsiveContainer>
                                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <span className="text-xs font-bold text-slate-400">Gastos</span>
                                        </div>
                                    </div>
                                    <div className="flex-1 space-y-3 w-full">
                                        <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                            <span className="text-sm text-slate-600 font-medium">Ingresos</span>
                                            <span className="font-bold text-slate-800">{formatCurrency(finances.income)}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-rose-50 rounded-xl border border-rose-100">
                                            <span className="text-sm text-rose-700 font-medium">Gastos Totales</span>
                                            <span className="font-bold text-rose-800">-{formatCurrency(totalExpensesReal)}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                                            <span className="text-sm text-emerald-700 font-bold">Disponible Real</span>
                                            <span className="font-bold text-emerald-800 text-lg">{formatCurrency(surplus)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-2xl shadow-md border border-indigo-100 relative overflow-hidden">
                                <div className="relative z-10">
                                    <h3 className="font-bold text-indigo-900 mb-2 flex items-center">
                                        <Target className="w-5 h-5 mr-2 text-indigo-600"/>
                                        Potencial de Aceleración
                                    </h3>
                                    <div className="flex flex-col gap-3 mt-4">
                                        <div className="flex justify-between items-end mb-1">
                                            <span className="text-xs font-bold text-indigo-400 uppercase">Abono Sugerido</span>
                                            <span className="text-3xl font-black text-indigo-600">{formatCurrency(recommendedExtra)}</span>
                                        </div>
                                        <button 
                                            onClick={() => onApplyExtra(recommendedExtra)}
                                            className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-[1.02] transition-all flex items-center justify-center"
                                        >
                                            <Zap className="w-5 h-5 mr-2 fill-current" />
                                            Aplicar esta cantidad
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CreditCardIcon = ({ size, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
        );

        const DashboardView = ({ metrics, graphData }) => {
            const CustomTooltip = ({ active, payload, label }) => {
                if (active && payload && payload.length) {
                    return (
                        <div className="bg-white/95 backdrop-blur-sm p-3 border border-slate-200 shadow-xl rounded-xl text-xs z-50">
                            <p className="font-bold text-slate-700 mb-2">Mes {label}</p>
                            <div className="space-y-1">
                                <p className="text-slate-500">Banco: <span className="font-mono font-medium text-slate-700">{formatCurrency(payload[0].value)}</span></p>
                                <p className="text-emerald-600">Estrategia: <span className="font-mono font-bold">{formatCurrency(payload[1].value)}</span></p>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="space-y-6 pb-20 lg:pb-0 animate-in fade-in duration-500">
                    {/* KPI Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between relative overflow-hidden group min-h-[160px]">
                            <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                <Wallet size={80} className="text-emerald-600"/>
                            </div>
                            <div>
                                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Ahorro Intereses</p>
                                <h3 className="text-2xl lg:text-3xl font-extrabold text-emerald-600 tracking-tight break-words">{formatCurrency(metrics.interestSaved)}</h3>
                            </div>
                            <div className="mt-auto pt-4 flex items-center w-full">
                                <div className="text-xs font-medium text-emerald-700 bg-emerald-50 px-2.5 py-1.5 rounded-lg border border-emerald-100 flex items-center w-full">
                                    <TrendingDown size={14} className="mr-1.5 shrink-0" /> 
                                    <span className="truncate">Dinero ahorrado</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between relative overflow-hidden group min-h-[160px]">
                            <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                <Calendar size={80} className="text-blue-600"/>
                            </div>
                            <div>
                                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Tiempo Ganado</p>
                                <h3 className="text-2xl lg:text-3xl font-extrabold text-blue-600 tracking-tight flex flex-wrap gap-x-2 items-baseline">
                                    <span>{Math.floor(metrics.monthsSaved / 12)} <span className="text-lg text-slate-400 font-semibold">años</span></span>
                                    <span>{metrics.monthsSaved % 12} <span className="text-lg text-slate-400 font-semibold">meses</span></span>
                                </h3>
                            </div>
                            <div className="mt-auto pt-4 flex items-center w-full">
                                <div className="text-xs font-medium text-blue-700 bg-blue-50 px-2.5 py-1.5 rounded-lg border border-blue-100 flex items-center w-full">
                                    <Target size={14} className="mr-1.5 shrink-0" /> 
                                    <span className="truncate">-{metrics.timeReductionPct.toFixed(0)}% del plazo total</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between min-h-[160px]">
                            <div>
                                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total a Pagar</p>
                                <h3 className="text-2xl font-extrabold text-slate-700 break-words">{formatCurrency(metrics.totalPaymentNew)}</h3>
                            </div>
                            <div className="mt-auto pt-4 flex items-center w-full">
                                <div className="text-xs font-medium text-slate-500 bg-slate-50 px-2.5 py-1.5 rounded-lg border border-slate-100 flex items-center w-full">
                                    <DollarSign size={14} className="mr-1.5 shrink-0" /> 
                                    <span className="truncate">Antes: <span className="line-through decoration-rose-400">{formatCurrency(metrics.totalPaymentOriginal)}</span></span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between relative overflow-hidden min-h-[160px]">
                            <div className="absolute -right-4 -top-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                            <div>
                                <p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-2">Impacto Estrategia</p>
                                <div className="flex items-baseline gap-2">
                                    <h3 className="text-2xl font-extrabold text-white">Excelente</h3>
                                    <span className="text-sm text-yellow-300 font-medium">★★★★★</span>
                                </div>
                            </div>
                            <div className="mt-auto pt-4 text-xs text-indigo-50 leading-relaxed font-medium border-t border-white/10">
                                {metrics.isUVR 
                                    ? "En créditos UVR, los abonos a capital son críticos para amortiguar la inflación."
                                    : `Por cada $1,000 extra, ahorras ${formatCurrency((metrics.interestSaved / (metrics.monthlyTotalEffort * metrics.newTerm - metrics.monthlyObligatory * metrics.newTerm) * 1000 || 0))} en intereses futuros.`
                                }
                            </div>
                        </div>
                    </div>

                    {/* Impacto Mensual Detallado */}
                    <div className="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm flex flex-col sm:flex-row items-center justify-between gap-6 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        
                        {/* Banco */}
                        <div className="flex-1 w-full relative z-10">
                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1 flex items-center">
                                <span className="w-2 h-2 rounded-full bg-slate-300 mr-2"></span>
                                Pago Mínimo {metrics.isUVR ? "(Estimado Inicial)" : "(Banco)"}
                            </p>
                            <div className="flex items-baseline gap-2">
                                <h3 className="text-2xl lg:text-3xl font-bold text-slate-700">{formatCurrency(metrics.monthlyObligatory)}</h3>
                                <span className="text-xs text-slate-400 font-medium">/mes</span>
                            </div>
                            <p className="text-xs text-slate-400 mt-1 pl-4">
                                {metrics.isUVR ? "Varía cada mes con la inflación" : "Cuota obligatoria + Seguros"}
                            </p>
                        </div>

                        <div className="hidden sm:flex text-slate-300"><ArrowRight size={24} /></div>

                        <div className="flex-1 w-full relative z-10">
                            <p className="text-emerald-600 text-xs font-bold uppercase tracking-wider mb-1 flex items-center">
                                <span className="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
                                Nuevo Aporte Total
                            </p>
                            <div className="flex items-baseline gap-2">
                                <h3 className="text-2xl lg:text-3xl font-bold text-emerald-600">{formatCurrency(metrics.monthlyTotalEffort)}</h3>
                                <span className="text-xs text-emerald-600/60 font-medium">/mes</span>
                            </div>
                            <p className="text-xs text-emerald-600/70 mt-1 pl-4">Incluye tu abono inteligente</p>
                        </div>

                        <div className="w-full sm:w-auto bg-slate-50 rounded-xl p-4 border border-slate-100 min-w-[200px]">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-slate-500 text-xs font-bold">Esfuerzo Adicional</span>
                                <TrendingUp size={16} className="text-amber-500" />
                            </div>
                            <div className="flex items-end gap-1 mb-2">
                                <span className="text-2xl font-black text-slate-800">+{metrics.effortIncreasePct.toFixed(1)}%</span>
                                <span className="text-xs text-slate-500 font-medium mb-1.5">vs cuota inicial</span>
                            </div>
                            <div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                                <div className="bg-amber-500 h-full rounded-full transition-all duration-1000" style={{ width: `${Math.min(metrics.effortIncreasePct, 100)}%` }}></div>
                            </div>
                        </div>
                    </div>

                    {/* Gráfica */}
                    <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-2">
                            <h3 className="font-bold text-slate-800 flex items-center text-lg">
                                <BarChart3 className="w-5 h-5 mr-2 text-indigo-500"/>
                                Proyección de Libertad (Saldos en Pesos)
                            </h3>
                            <div className="flex gap-4 text-xs bg-slate-50 p-2 rounded-lg border border-slate-100">
                                <div className="flex items-center"><span className="w-2.5 h-2.5 rounded-full bg-slate-400 mr-2"></span> Banco</div>
                                <div className="flex items-center"><span className="w-2.5 h-2.5 rounded-full bg-emerald-500 mr-2"></span> Estrategia</div>
                            </div>
                        </div>
                        
                        <div className="h-64 sm:h-80 w-full -ml-2">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={graphData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                    <defs>
                                        <linearGradient id="colorBanco" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.2}/>
                                            <stop offset="95%" stopColor="#94a3b8" stopOpacity={0}/>
                                        </linearGradient>
                                        <linearGradient id="colorEstrategia" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                                            <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <XAxis 
                                        dataKey="mes" 
                                        tick={{fontSize: 10, fill: '#94a3b8'}} 
                                        axisLine={false}
                                        tickLine={false}
                                        tickFormatter={(val) => val % 24 === 0 ? `${val/12}A` : ''} 
                                    />
                                    <YAxis 
                                        tickFormatter={(val) => `${val/1000000}M`} 
                                        tick={{fontSize: 10, fill: '#94a3b8'}}
                                        axisLine={false}
                                        tickLine={false}
                                        width={40}
                                    />
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <Tooltip content={<CustomTooltip />} />
                                    <Area 
                                        type="monotone" 
                                        dataKey="deudaBanco" 
                                        stroke="#94a3b8" 
                                        strokeWidth={2}
                                        strokeDasharray="4 4"
                                        fill="url(#colorBanco)" 
                                        animationDuration={1000}
                                    />
                                    <Area 
                                        type="monotone" 
                                        dataKey="deudaEstrategia" 
                                        stroke="#10b981" 
                                        strokeWidth={3}
                                        fill="url(#colorEstrategia)" 
                                        animationDuration={1000}
                                    />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                        {metrics.isUVR && (
                             <p className="text-[10px] text-slate-400 mt-2 text-center italic">
                                * Nota: En créditos UVR, el saldo en pesos puede subir al inicio aunque abones, debido a que la corrección monetaria (inflación) supera a la amortización de capital.
                             </p>
                        )}
                    </div>
                </div>
            );
        };

        const LegalGenerator = ({ inputs }) => {
            const [type, setType] = useState("plazo"); 
            const [mode, setMode] = useState("template"); 
            const [personalData, setPersonalData] = useState({
                name: "",
                cc: "",
                bank: "",
                creditNumber: "",
                city: "Bogotá D.C."
            });

            const letterRef = useRef(null);

            const handleCopy = () => {
                if (letterRef.current) {
                    const text = letterRef.current.innerText;
                    navigator.clipboard.writeText(text);
                    alert("Texto copiado.");
                }
            };
            const handlePrint = () => window.print();

            return (
                <div className="max-w-4xl mx-auto space-y-6 pb-24 lg:pb-0 animate-in fade-in">
                    <div className="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-6 relative overflow-hidden no-print">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><ShieldCheck size={120} className="text-amber-600"/></div>
                        <div className="relative z-10">
                            <h2 className="text-lg font-bold text-amber-900 mb-2">Ley de Vivienda 546 de 1999</h2>
                            <p className="text-amber-800 text-sm mb-4">Derecho irrenunciable al prepago sin penalidad.</p>
                            <a href="https://www.funcionpublica.gov.co/eva/gestornormativo/norma.php?i=398" target="_blank" className="text-xs font-bold text-amber-700 underline">Ley 546 de 1999 - Gestor Normativo - Función Pública</a>
                        </div>
                    </div>

                    <div className="bg-white p-4 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                         {/* Configuración Carta */}
                        <div className="no-print space-y-6 mb-8 border-b border-slate-100 pb-8">
                            <div className="flex gap-4">
                                <button onClick={() => setType("plazo")} className={`px-4 py-2 rounded-md text-sm font-bold ${type === 'plazo' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100'}`}>Reducir Plazo</button>
                                <button onClick={() => setType("cuota")} className={`px-4 py-2 rounded-md text-sm font-bold ${type === 'cuota' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100'}`}>Reducir Cuota</button>
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto bg-slate-50 rounded-xl p-2 md:p-8 md:bg-gray-100 mb-6">
                            <div ref={letterRef} className="letter-paper font-serif text-slate-900 leading-relaxed max-w-[21.59cm] mx-auto bg-white min-h-[27.94cm] p-[2.5cm] shadow-xl text-justify text-[11pt]">
                                <p className="mb-8 text-right">{personalData.city || "Ciudad"}, {new Date().toLocaleDateString()}</p>
                                <p className="mb-6">Señores<br/><strong>{personalData.bank || "[BANCO]"}</strong></p>
                                <p className="mb-4">Ref: Solicitud Abono Extraordinario - Crédito {personalData.creditNumber || "___________"}</p>
                                <p className="mb-4">De conformidad con la Ley 546 de 1999, solicito aplicar el abono de <strong>{formatCurrency(inputs.extraMonthly)}</strong> a capital para: <strong>{type === 'plazo' ? "REDUCIR PLAZO" : "REDUCIR CUOTA"}</strong>.</p>
                                <br/><br/>
                                <p>Cordialmente,</p>
                                <br/>
                                <p className="font-bold">__________________________</p>
                                <p>Titular</p>
                                <div className="mt-12 text-[10px] text-slate-400 text-center border-t border-slate-100 pt-4 print:hidden">
                                    Generado con CrediMaster Pro - Autor: Jose Manuel Mejia Erazo
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex gap-4 no-print">
                            <button onClick={handleCopy} className="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold">Copiar</button>
                            <button onClick={handlePrint} className="flex-1 border border-slate-200 py-3 rounded-xl font-bold">Imprimir</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [inputs, setInputs] = useState({
                loanAmount: 180000000,
                rateEA: 13.5,
                months: 240,
                insurance: 65000,
                extraMonthly: 400000,
                oneTimePayment: 0,
                usePrimas: true,
                currentQuota: 0,
                // Nuevos campos UVR
                isUVR: false,
                uvrValue: 360.5432, // Ejemplo valor UVR
                inflation: 4.5 // Ejemplo inflación anual
            });
            const [aiReport, setAiReport] = useState(null);
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);

            const debouncedInputs = useDebounce(inputs, 300);
            const results = useMemo(() => calculateEngine(debouncedInputs), [debouncedInputs]);

            const handleInputChange = (field, value) => {
                setInputs(prev => ({ ...prev, [field]: value }));
                if(activeTab === 'advisor') setAiReport(null);
            };

            const handleApplyBudget = (amount) => {
                setInputs(prev => ({...prev, extraMonthly: Math.round(amount)}));
                setActiveTab('dashboard');
            };

            const handleGenerateReport = async () => {
                // ... (Mantener lógica IA igual pero añadiendo contexto UVR si aplica)
                setIsGeneratingReport(true);
                setTimeout(() => {
                    setAiReport("Análisis IA Simulado: Gran estrategia. Mantener el abono extra reduce significativamente los intereses.");
                    setIsGeneratingReport(false);
                }, 1500);
            };

            const renderContent = () => {
                if (!results) return <div className="p-10 text-center text-slate-400">Cargando motor financiero...</div>;

                switch(activeTab) {
                    case 'dashboard': return <DashboardView metrics={results.metrics} graphData={results.graphData} />;
                    case 'budget': return <BudgetView onApplyExtra={handleApplyBudget} />;
                    case 'advisor': return (
                         <div className="max-w-2xl mx-auto space-y-6 pb-24 lg:pb-0 animate-in fade-in">
                            <div className="bg-indigo-900 rounded-3xl p-8 text-white text-center">
                                <h2 className="text-2xl font-bold mb-4">IA Advisor</h2>
                                <button onClick={handleGenerateReport} className="bg-white text-indigo-900 px-6 py-2 rounded-full font-bold">Generar Reporte</button>
                                {aiReport && <div className="mt-4 text-left bg-white/10 p-4 rounded-xl">{aiReport}</div>}
                            </div>
                        </div>
                    );
                    case 'schedule':
                        return (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden pb-20 lg:pb-0 animate-in fade-in">
                                <div className="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-700">Tabla de Amortización {inputs.isUVR ? "(Proyección Pesos)" : ""}</h3>
                                    {inputs.isUVR && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-bold">Modo UVR</span>}
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                            <tr>
                                                <th className="px-4 py-3">Mes</th>
                                                {inputs.isUVR && <th className="px-4 py-3 text-right text-purple-400">UVR Unit</th>}
                                                <th className="px-4 py-3 text-right">Cuota Total</th>
                                                <th className="px-4 py-3 text-right text-blue-600">Abono Ord.</th>
                                                <th className="px-4 py-3 text-right text-emerald-600">Extra</th>
                                                <th className="px-4 py-3 text-right text-indigo-700 font-bold">Abono Total</th>
                                                <th className="px-4 py-3 text-right text-rose-500">Interés</th>
                                                <th className="px-4 py-3 text-right">Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {results.schedule.map((row) => (
                                                <tr key={row.month} className="hover:bg-slate-50/50 transition-colors">
                                                    <td className="px-4 py-3 font-medium text-slate-900">{row.month}</td>
                                                    {inputs.isUVR && <td className="px-4 py-3 text-right text-purple-400 text-xs">{formatNumber(row.uvrUnitValue, 2)}</td>}
                                                    <td className="px-4 py-3 text-right font-medium">{formatCurrency(row.paymentTotal)}</td>
                                                    <td className="px-4 py-3 text-right text-blue-600">{formatCurrency(row.capitalOrdinary)}</td>
                                                    <td className="px-4 py-3 text-right text-emerald-600 font-medium">{row.extraApplied > 0 ? `+${formatCurrency(row.extraApplied)}` : '-'}</td>
                                                    <td className="px-4 py-3 text-right text-indigo-700 font-bold bg-indigo-50/30">{formatCurrency(row.capitalTotal)}</td>
                                                    <td className="px-4 py-3 text-right text-rose-500">{formatCurrency(row.interest)}</td>
                                                    <td className="px-4 py-3 text-right font-bold text-slate-700">{formatCurrency(row.balance)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );
                    case 'settings':
                        return (
                            <div className="pb-24 animate-in slide-in-from-bottom-4">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 px-1">Configuración</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <CreditParametersForm inputs={inputs} handleInputChange={handleInputChange} />
                                </div>
                            </div>
                        );
                    case 'legal': return <LegalGenerator inputs={inputs} />;
                    default: return null;
                }
            };

            const navItems = [
                { id: 'dashboard', label: 'Inicio', icon: PieChart },
                { id: 'budget', label: 'Estudio', icon: Calculator },
                { id: 'schedule', label: 'Tabla', icon: List },
                { id: 'advisor', label: 'IA Asesor', icon: BrainCircuit },
                { id: 'legal', label: 'Legal', icon: FileText },
            ];

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col lg:flex-row overflow-hidden">
                    <aside className="hidden lg:flex flex-col w-80 bg-white border-r border-slate-200 h-screen overflow-y-auto fixed left-0 top-0 z-30 shadow-xl lg:shadow-none">
                        <div className="p-6 border-b border-slate-100">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2.5 rounded-xl shadow-lg shadow-blue-200/50"><TrendingDown size={24} className="text-white" /></div>
                                <div><h1 className="font-bold text-xl leading-none text-slate-900 tracking-tight">CrediMaster</h1><span className="text-[10px] text-blue-600 font-bold tracking-[0.2em] uppercase">Pro</span></div>
                            </div>
                        </div>
                        <div className="p-6 space-y-8 flex-1">
                            <nav className="space-y-1">
                                {navItems.map((item) => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl text-sm font-medium transition-all duration-200 ${activeTab === item.id ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'}`}>
                                        <item.icon size={20} className={activeTab === item.id ? 'text-blue-600' : 'text-slate-400'} />
                                        <span>{item.label}</span>
                                        {activeTab === item.id && <ChevronRight size={16} className="ml-auto opacity-50"/>}
                                    </button>
                                ))}
                            </nav>
                            <div className="pt-6 border-t border-slate-100"><CreditParametersForm inputs={inputs} handleInputChange={handleInputChange} /></div>
                            <div className="pt-6 mt-auto text-center opacity-70 hover:opacity-100 transition-opacity">
                                <p className="text-[10px] text-slate-400 font-medium uppercase tracking-wider mb-1">Desarrollado por</p>
                                <div className="flex items-center justify-center gap-2 text-slate-600"><Code2 size={14} className="text-blue-500" /><span className="font-bold text-xs">Jose Mejia</span></div>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 lg:ml-80 h-screen overflow-y-auto bg-slate-50/50">
                        <header className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 lg:hidden flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-1.5 rounded-lg"><TrendingDown size={16} className="text-white" /></div>
                                <div className="flex flex-col"><span className="font-bold text-slate-800 text-sm leading-tight">CrediMaster</span><span className="text-[9px] text-slate-400 font-medium leading-tight">by jm_erazo</span></div>
                            </div>
                            <div className="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full">v2.1</div>
                        </header>
                        <div className="p-4 md:p-8 md:max-w-6xl md:mx-auto">{renderContent()}</div>
                    </main>

                    <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-30 pb-safe px-2 py-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <div className="flex justify-around items-center">
                            {navItems.map((item) => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all ${activeTab === item.id ? 'text-blue-600' : 'text-slate-400'}`}>
                                    <div className={`p-1 rounded-full mb-1 transition-all ${activeTab === item.id ? 'bg-blue-50 transform -translate-y-1' : ''}`}><item.icon size={20} strokeWidth={activeTab === item.id ? 2.5 : 2} /></div>
                                    <span className="text-[10px] font-medium">{item.label}</span>
                                </button>
                            ))}
                            <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all ${activeTab === 'settings' ? 'text-emerald-600' : 'text-slate-400'}`}>
                                <div className={`p-1 rounded-full mb-1 transition-all ${activeTab === 'settings' ? 'bg-emerald-50 transform -translate-y-1' : ''}`}><Settings size={20} strokeWidth={activeTab === 'settings' ? 2.5 : 2} /></div>
                                <span className="text-[10px] font-medium">Ajustes</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
    </html>
